<!doctype html> 
<html> 
<head> 
	<title>TwiticaDesktop+ Options</title> 
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
	<script src="../jquery.js" type="text/javascript"></script> 
	<script src="sha1.js" type="text/javascript"></script> 
	<script src="oauth.js" type="text/javascript"></script> 
	<script src="twitter.js" type="text/javascript"></script> 
	<script type="text/javascript"> 
var tw = new Twitter(), lsPoller;
function showLogout(){
	$("#twauth").html("<a href='#'>Logout</a>").unbind("click").click(function(){
		delete localStorage.twitterKey;
		delete localStorage.twitterUser;
		delete localStorage.twitterData;
		window.location.reload();
	});
}
$(function(){
	if(localStorage.twitterUser){
		$("#login-status").html("Currently logged in as <b>"+localStorage.twitterUser+"</b>");
		showLogout();
	}else{
		$("#login-status").html("Not logged in.");
		tw.oauth(function(d){
			$("#twauth").html("<img src='http://a0.twimg.com/images/dev/buttons/sign-in-with-twitter-d.png'>").unbind("click").click(function(){
				$(this).html("");
				localStorage._tmp_pin = "not loaded";
				twAuth=window.open(d.url, "twAuth", "status=0,toolbar=0,location=0,menubar=0,directories=0,scrollbars=0,width=800,height=400");
				lsPoller = setInterval((function(data){
					if(localStorage._tmp_pin != "not loaded"){
						twAuth.close();
						clearTimeout(lsPoller);
						
						$("#twauth").html("Exchanging token...");
						tw.oauth2(localStorage._tmp_pin, data, function(res){
							if(!res) return alert("Cannot authenticate to Twitter!");
							tw.get("account/verify_credentials", null, function(d){
								localStorage.twitterUser = d.screen_name;
								localStorage.twitterData = JSON.stringify(d);
								localStorage.twitterKey = JSON.stringify([
									tw.consumer.token,
									tw.consumer.tokenSecret,
								]);
								$("#login-status").html("Currently logged in as <b>"+localStorage.twitterUser+"</b>");
								showLogout();
							});
						});
					}
				}).bind(this, d.data), 10);
			});
		});
	}
	$("#launchlink").attr("href", window.location.toString().replace("twplus/options.html", "index.html"));
});
	</script> 
	<style type="text/css"> 
body{
	margin:0; padding:0;
	font-family: verdana, "Lucida Sans", "Dejavu Sans", sans-serif;
	background: #333;
	color: white;
	font-size: 12pt;
}
header{
	background: #111;
	border-bottom: #555 solid 1px;
	font-size: 24pt;
	padding:5px;
}
#body{
	padding: 30px;
}
a{
	color: #eee;
}
fieldset{
	border: #555 solid 1px;
	-webkit-box-shadow: black 0px 2px 10px;
	margin-bottom: 20px;
}
	</style> 
</head> 
<body> 
<header> 
	TwiticaDesktop+ Options
</header> 
<div id="body"> 
	<fieldset id="twitter"> 
		<legend for="twitter">Twitter</legend> 
		<p id="login-status"></p>
		<div id="twauth">Waiting for API...</div>
	</fieldset>
	<fieldset id="launch"> 
		<legend for="launch">Launch</legend> 
		<a href="#" id="launchlink">Launch</a>
		<p><b>Tip:</b> To create shortcut, press the wrench icon at top right and click Tools&gt;Create application shortcuts.</p>
	</fieldset> 
</div> 
</body> 
</html> 